# 【考场速记】第9章 - 数据库安全

> ⭐ 老师说不咋考，内容多但点集中，偏选择/简答

---

## 一、安全模型层次 ⭐⭐

**一级一级层层设置**（从外到内）：
1. **用户标识和鉴别** - 最外层
2. **存取控制** - DBMS层（DAC/MAC）
3. **视图、审计** - 细粒度控制
4. **操作系统安全保护** - OS层
5. **密码保护** - 数据库层

---

## 二、安全要求与威胁 ⭐

### 三大安全要求
- **保密性** - 数据不泄露
- **完整性与一致性** - 数据正确可靠
- **有效性** - 数据可用

### 三大安全威胁
- **外部攻击** - 黑客入侵
- **权限滥用** - 合法用户越权
- **内部人员窃取** - 内鬼泄密

---

## 三、用户标识与鉴别 ⭐

**作用**：最外层安全保护

**常用方法**：
1. **用户名/口令** - 简单易行，易被窃取
2. **随机数+函数计算** - 系统提供随机数，用户计算验证

---

## 四、存取控制 ⭐⭐⭐

### DAC（自主存取控制）⭐⭐⭐

**特点**：用户可以控制

**实现**：
- **授权**：`GRANT` - 给权限
- **收回**：`REVOKE` - 收回权限

**机制**：查数据字典检查权限

---

### MAC（强制存取控制）⭐⭐

**特点**：
- 系统强制执行，用户**不能直接感知或控制**
- 按TDI/TCSEC安全标准
- 适用于**严格密级分类部门**（如军事）

**与DAC区别**：

| 对比项 | DAC（自主） | MAC（强制） |
|--------|------------|-------------|
| 控制者 | 用户可控 | 系统强制 |
| 灵活性 | 灵活 | 固定 |
| 感知度 | 用户感知 | 用户无感 |
| 适用场景 | 一般企业 | 高密级部门 |

---

## 五、视图机制 ⭐⭐

**作用**：把保密数据对无权用户隐藏

**使用方式**：**视图 + 授权机制配合**
1. 先建视图（屏蔽部分数据）
2. 再在视图上授权

**示例逻辑**：
```
CREATE VIEW 视图名 AS SELECT ...  -- 先建视图
GRANT SELECT ON 视图名 TO 用户   -- 再授权
```

---

## 六、审计 ⭐⭐⭐

### 核心概念
**审计 = 专用审计日志（Audit Log）记录用户所有操作**

### 作用
- **监视措施** - 跟踪记录数据访问活动
- **DBA利用审计日志** - 找出非法存取的人、时间、内容

### 实现方式
**触发器 + 审计表**：
- 创建审计表（记录：谁、何时、改了什么、旧值、新值）
- 创建触发器（`AFTER UPDATE` → 自动记录）

### 注意
- **很费时间和空间**
- DBA可灵活打开/关闭

---

## 七、数据加密 ⭐⭐⭐

### 解决的问题
1. DBA可无限制访问数据
2. 非法用户盗取文件/磁盘/内存
3. 存储设备被盗
4. **网络传输被窃听**

---

### 加密算法 ⭐⭐⭐

| 类型 | 密钥特点 | 典型算法 |
|------|----------|----------|
| **对称加密** | 加密解密用**同一密钥** | **DES、AES** |
| **非对称加密** | 需**公钥+私钥**两个密钥 | **RSA** |

**记忆**：对称=一把钥匙，非对称=两把钥匙

---

### 加密实现层次

**3个层次**（从底层到顶层）：
1. **操作系统层** - 最底层
2. **DBMS内核层** - 中间层
3. **DBMS外层** - 最外层（客户端）

---

### 加密优点
- **对用户透明** - 用户无感知
- **独立于应用系统** - 无需改动应用
- **客户端加解密** - 不影响服务器效率

### 需考虑的问题
- 加密粒度：字段/记录/表
- 加密数据选择
- 密钥动态管理
- 加密透明性

---

## 八、MySQL安全 ⭐⭐

### 权限系统两阶段
1. **身份认证** - IP地址+用户名联合认证
2. **权限赋予** - 通过后赋予权限

### 重要权限表 ⭐

| 权限表 | 作用范围 |
|--------|----------|
| **user表** | 针对**所有数据库**的全局权限（39字段） |
| **db表** | 针对**某个数据库**的权限（22字段） |
| tables_priv | 针对**单个表**的权限 |
| columns_priv | 针对**单个列**的权限 |
| procs_priv | 针对**存储过程/函数**的权限 |

**检查顺序**：user → db → tables_priv → columns_priv（权限范围递减）

**规则**：全局权限Y则全Y，不再检查后面

---

### MySQL用户管理

```sql
-- 创建用户
CREATE USER '用户'@'主机' IDENTIFIED BY '密码'

-- 修改用户
RENAME USER '旧用户'@'主机' TO '新用户'@'主机'

-- 删除用户
DROP USER '用户'@'主机'
```

**注意**：`'root'@'localhost'` vs `'root'@'%'`（%=任意主机）

---

### MySQL权限管理 ⭐⭐⭐

```sql
-- 授权
GRANT 权限 ON 数据库.表 TO 用户 [WITH GRANT OPTION]

-- 收回
REVOKE 权限 ON 数据库.表 FROM 用户

-- 查看权限
SHOW GRANTS FOR '用户'@'主机'
```

**WITH GRANT OPTION**：被授权用户可将权限转授他人

---

### MySQL角色管理 ⭐

```sql
CREATE ROLE '角色'           -- 创建角色
GRANT 权限 TO '角色'          -- 给角色授权
GRANT 角色 TO 用户            -- 给用户赋角色
SET DEFAULT ROLE 角色 TO 用户 -- 激活角色
DROP ROLE 角色                -- 删除角色
```

---

## 九、SQL Server安全 ⭐⭐

### 身份验证模式 ⭐

| 模式 | 说明 | 安全性 |
|------|------|--------|
| **Windows验证** | 用Windows账户，系统验证 | 更安全（默认） |
| **混合验证** | Windows + SQL Server账户 | 灵活但需强密码 |

---

### 安全主体三级别 ⭐⭐

1. **服务器级别** - 登录名、固定服务器角色
2. **数据库级别** - 用户、角色、证书等
3. **架构级别** - 表、视图、存储过程等（默认架构dbo）

**验证流程**：登录名登录 → 映射用户 → 检查权限

---

### 登录用户 vs 数据库用户 ⭐⭐

| 概念 | 作用 | 管理者 |
|------|------|--------|
| **登录用户** | 登录SQL Server服务器 | 系统管理员 |
| **数据库用户** | 访问具体数据库 | 数据库管理员 |

**关系**：必须先是登录用户，才能成为数据库用户

**默认登录名**：
- **sa** - 系统管理员，拥有所有权限，不能删除
- **BUILTIN\Administrator** - Windows管理员

---

### SQL Server用户管理

```sql
-- 创建登录名（Windows）
CREATE LOGIN [计算机名\用户] FROM WINDOWS

-- 创建登录名（SQL Server）
CREATE LOGIN 用户 WITH PASSWORD='密码'

-- 创建数据库用户
CREATE USER 用户 FROM LOGIN 登录名 WITH DEFAULT_SCHEMA=dbo

-- 删除
DROP LOGIN 登录名
DROP USER 用户
```

---

### SQL Server角色管理 ⭐⭐

**创建角色**：
```sql
CREATE ROLE 角色名 [AUTHORIZATION 所有者]
```

**用户与角色**：
```sql
SP_ADDROLEMEMBER '角色', '用户'     -- 添加用户到角色
SP_DROPROLEMEMBER '角色', '用户'    -- 从角色删除用户
```

---

### 固定服务器角色 ⭐⭐

| 角色 | 权限 |
|------|------|
| **SYSADMIN** | 系统管理员，**所有权限** |
| SERVERADMIN | 服务器管理员，配置服务器 |
| SECURITYADMIN | 安全管理员，管理登录/密码 |
| DBCREATOR | 数据库创建者，创建/修改数据库 |
| PROCESSADMIN | 进程管理员 |
| DISKADMIN | 磁盘管理员 |
| BULKADMIN | 块数据操作管理员 |

---

### 固定数据库角色 ⭐⭐

| 角色 | 权限 |
|------|------|
| **DB_OWNER** | 数据库所有者，**全部权限** |
| DB_ACCESSADMIN | 访问权限管理员 |
| DB_SECURITYADMIN | 安全管理员 |
| DB_DDLADMIN | DDL管理员 |
| DB_BACKUPOPERATOR | 备份操作员 |
| **DB_DATAREADER** | 可读所有数据 |
| **DB_DATAWRITER** | 可改所有数据 |
| DB_DENYDATAREADER | 拒绝读数据 |
| DB_DENYDATAWRITER | 拒绝写数据 |

---

### PUBLIC角色 ⭐

**特点**：
- 初始状态**无权限**
- **所有数据库用户都是其成员**
- 给PUBLIC授权 = 给所有用户授权

---

### SQL Server权限管理 ⭐⭐⭐

**授予**：
```sql
-- 语句权限
GRANT CREATE DATABASE, CREATE TABLE TO 用户

-- 对象权限
GRANT SELECT, INSERT, UPDATE, DELETE ON 表 TO 用户
GRANT UPDATE(列) ON 表 TO 用户  -- 列级权限

-- 带转授权
GRANT INSERT ON 表 TO 用户 WITH GRANT OPTION
```

**收回**：
```sql
REVOKE INSERT ON 表 FROM 用户

-- 级联收回（自动收回从此用户获得的权限）
```

**禁止**：
```sql
DENY UPDATE, DELETE ON 表 TO 用户

-- DENY优先级最高，即使在有权限的角色中也被禁止
-- 解除禁止需用GRANT显式授权
```

**权限优先级**：**DENY > GRANT > 无权限**

---

## 速记口诀 ⭐⭐⭐

1. **安全模型** = 用户鉴别 → 存取控制 → 视图审计 → OS保护 → 加密
2. **DAC vs MAC** = 自主可控 vs 强制固定
3. **视图** = 先建视图后授权
4. **审计** = 触发器+审计表（谁、何时、改啥）
5. **加密** = 对称一钥匙（DES/AES）、非对称两钥匙（RSA）
6. **MySQL权限表** = user（全局）→ db（库）→ tables（表）→ columns（列）
7. **SQL Server** = 登录名登录 → 用户访问库 → 检查权限
8. **角色** = 权限集合，简化授权
9. **权限三操作** = GRANT授、REVOKE收、DENY禁

---

## 选择题速记 ⭐⭐⭐

### DAC相关
- ✓ 用户可控，用GRANT/REVOKE
- ✓ 查数据字典检查权限
- ✓ 定义权限+检查权限=安全子系统

### MAC相关
- ✓ 系统强制，用户无感
- ✓ 按TDI/TCSEC标准
- ✓ 适用严格密级部门
- ✗ 用户可直接控制（错！）

### 视图相关
- ✓ 视图+授权配合使用
- ✓ 隐藏保密数据
- ✗ 视图单独可实现安全（错！需配合授权）

### 审计相关
- ✓ 审计日志记录所有操作
- ✓ 费时费空间
- ✓ DBA可灵活开关
- ✓ 找出非法存取的人/时间/内容

### 加密相关
- ✓ 对称加密：DES、AES（同一密钥）
- ✓ 非对称加密：RSA（公钥+私钥）
- ✓ 客户端加解密不影响服务器
- ✓ 三层次：OS层/内核层/外层

### MySQL相关
- ✓ IP+用户名联合认证
- ✓ user表=全局权限
- ✓ 权限范围：user > db > tables_priv > columns_priv
- ✓ `'root'@'%'` = 任意主机连接
- ✓ `'root'@'localhost'` = 仅本地连接

### SQL Server相关
- ✓ Windows验证更安全
- ✓ sa=系统管理员，不能删除
- ✓ 登录用户≠数据库用户
- ✓ PUBLIC角色所有用户都是成员
- ✓ DENY优先级最高
- ✓ 权限级联收回
- ✗ 混合模式最安全（错！Windows验证最安全）

---

## 简答题速记 ⭐⭐⭐

### Q1：DAC和MAC的区别？
**DAC（自主）**：
- 用户可控制
- 用GRANT/REVOKE实现
- 灵活，适用一般企业

**MAC（强制）**：
- 系统强制，用户无感
- 按安全标准执行
- 固定密级，适用军事等高密部门

---

### Q2：视图机制如何实现安全？
1. 先建视图屏蔽保密数据
2. 再在视图上定义存取权限
3. 视图+授权配合使用

---

### Q3：审计的作用和实现？
**作用**：
- 跟踪记录数据访问活动
- 找出非法存取的人、时间、内容

**实现**：
- 创建审计日志表
- 用触发器自动记录操作

**注意**：费时费空间，可灵活开关

---

### Q4：对称加密和非对称加密的区别？

| 项目 | 对称加密 | 非对称加密 |
|------|----------|------------|
| 密钥 | 同一密钥 | 公钥+私钥 |
| 算法 | DES、AES | RSA |
| 速度 | 快 | 慢 |
| 安全性 | 密钥易泄露 | 更安全 |

---

### Q5：MySQL权限表的作用和检查顺序？
**4个主要权限表**：
1. user - 全局权限
2. db - 数据库权限
3. tables_priv - 表权限
4. columns_priv - 列权限

**检查顺序**：user → db → tables_priv → columns_priv  
**规则**：全局权限覆盖局部权限

---

### Q6：SQL Server登录用户和数据库用户的关系？
- **登录用户**：登录服务器（服务器级别）
- **数据库用户**：访问具体数据库（数据库级别）
- **关系**：必须先是登录用户，再成为数据库用户
- **映射**：登录名 → 数据库用户

---

### Q7：GRANT、REVOKE、DENY的区别？

| 操作 | 作用 | 优先级 | 特点 |
|------|------|--------|------|
| **GRANT** | 授权 | 中 | 给予权限 |
| **REVOKE** | 收回 | - | 撤销权限，级联收回 |
| **DENY** | 禁止 | **最高** | 明确禁止，需GRANT解除 |

**记忆**：DENY最狠，即使有GRANT也无效

---

## 考前必记 ⭐⭐⭐

### 概念必记
1. **DAC = 自主 = GRANT/REVOKE**
2. **MAC = 强制 = 用户无感 = 高密部门**
3. **视图 = 屏蔽+授权**
4. **审计 = 日志+触发器**
5. **对称(DES/AES) vs 非对称(RSA)**

### MySQL必记
- **user表 = 全局**，**db表 = 数据库级**
- **IP+用户名联合认证**
- **权限检查顺序**：user → db → tables → columns

### SQL Server必记
- **Windows验证 > 混合验证**
- **sa = 系统管理员**
- **登录用户 → 数据库用户**
- **DENY > GRANT > 无权限**
- **PUBLIC角色 = 所有用户**

### 对比必记
- DAC vs MAC
- 对称加密 vs 非对称加密
- 登录用户 vs 数据库用户
- GRANT vs REVOKE vs DENY
- 固定服务器角色 vs 固定数据库角色

---

**考场提醒**：本章选择/简答为主，重概念理解和对比，不考复杂SQL实现！

