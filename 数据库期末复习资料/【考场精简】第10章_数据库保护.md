# 【考场速记】第10章 - 数据库保护

> ⭐ 不考大题，主要选择/判断

---

## 一、事务ACID ⭐⭐⭐

- **A 原子性**：全做或全不做
- **C 一致性**：正确状态到正确状态
- **I 隔离性**：并发事务互不干扰
- **D 持续性**：提交后永久保存

**事务状态**：活动 → 部分提交 → 提交（或失败 → 异常结束）

---

## 二、并发5大问题 ⭐⭐⭐

1. **丢失修改** - 两事务同时改，一个覆盖另一个
2. **读脏数据** - 读到未提交的临时数据
3. **不可重复读** - 同一事务两次读同一数据不一致
4. **幻影行** - 同一事务两次查询记录数不同
5. **错误聚集** - 聚集函数计算时数据被修改

---

## 三、锁 ⭐⭐⭐

### 锁类型
- **S锁（共享锁）**：读锁，可多个事务同时持有
- **X锁（互斥锁）**：写锁，独占，不能与任何锁共存

### 三级封锁协议对比 ⭐⭐⭐

| 级别 | 读 | 写 | 防止问题 |
|------|----|----|----------|
| 一级 | 不锁 | X锁到底 | 丢失修改 |
| 二级 | S锁即释 | X锁到底 | 丢失修改 + 读脏数据 |
| 三级 | S锁到底 | X锁到底 | 丢失修改 + 读脏数据 + 不可重复读 |

**记忆口诀**：一级只写锁，二级读后放，三级全到底

---

## 四、死锁 ⭐⭐

### 死锁 vs 活锁
- **活锁**：某事务一直等（解决：先来先服务）
- **死锁**：多个事务互相等待对方的锁（循环等待）

### 死锁解决
- **预防**：一次加锁法、顺序加锁法
- **诊断**：超时法、等待图法（有回路=死锁）
- **解除**：撤销代价最小的事务

---

## 五、两段锁(2PL) ⭐⭐⭐

- **加锁阶段**：只能加锁，不能放锁
- **解锁阶段**：只能放锁，不能加锁

**作用**：保证调度可串行性

**关系**：
- 三级封锁 → 必遵守两段锁 ✓
- 两段锁 → 可能死锁 ✓
- 一次加锁法 → 遵守两段锁 ✓

---

## 六、意向锁 ⭐

- **IS锁**：准备在下层加S锁
- **IX锁**：准备在下层加X锁
- **SIX锁** = S锁 + IX锁

**强度**：X > SIX > S > IX > IS

**规则**：申请自上而下，释放自下而上

---

## 七、恢复技术 ⭐⭐⭐

### 日志格式
- `<T, start>` - 开始
- `<T, X, V1, V2>` - 修改（V1旧，V2新）
- `<T, commit>` - 提交

### 推迟更新 vs 即时更新

| 项目 | 推迟更新 | 即时更新 |
|------|----------|----------|
| 更新时机 | 提交时才更新 | 立即更新数据库 |
| 日志格式 | `<T,X,V2>` | `<T,X,V1,V2>` |
| 恢复操作 | 只需REDO | 需UNDO+REDO |
| 规则 | 有commit→REDO | 有commit→REDO<br>无commit→UNDO |

**REDO**：重做（用新值V2）  
**UNDO**：撤销（用旧值V1）  
**幂等性**：执行多次=执行一次

---

## 八、检测点 ⭐⭐

**作用**：减少恢复时搜索日志的时间

**操作**：
1. 日志写入永恒存储器
2. 修改的数据写入磁盘
3. 写`<checkpoint>`

**优点**：只需处理检测点后的事务

---

## 九、备份类型 ⭐⭐

| 类型 | 内容 | 优点 | 缺点 |
|------|------|------|------|
| **完全备份** | 全部数据 | 恢复简单 | 大、慢 |
| **差异备份** | 自上次完全备份的变化 | 较快 | 需完全+差异 |
| **增量备份** | 自上次任何备份的变化 | 最小最快 | 需完全+所有增量 |
| **日志备份** | 事务日志 | 恢复到时间点 | 配合其他使用 |

---

## 十、SQL Server备份/恢复 ⭐

### 备份
```sql
-- 完全
BACKUP DATABASE db TO DISK='path'

-- 差异
BACKUP DATABASE db TO DISK='path' WITH DIFFERENTIAL

-- 日志
BACKUP LOG db TO DISK='path'
```

### 恢复（按顺序）
```sql
-- 1.完全（不恢复）
RESTORE DATABASE db FROM DISK='path' WITH NORECOVERY

-- 2.差异（不恢复）
RESTORE DATABASE db FROM DISK='path' WITH NORECOVERY

-- 3.日志（恢复+时间点）
RESTORE LOG db FROM DISK='path' WITH RECOVERY, STOPAT='time'
```

**关键**：前面用`NORECOVERY`，最后一步用`RECOVERY`

---

## 速记口诀 ⭐⭐⭐

1. **ACID** = 原一隔持
2. **并发5问题** = 丢读脏、不重复、幻影行、聚集错
3. **三级封锁** = 一X二S放三S底
4. **两段锁** = 先加后放、保串行
5. **死锁** = 预（一次/顺序）诊（超时/图）解（撤小）
6. **恢复** = 推迟REDO、即时UNDO+REDO
7. **备份** = 完全最大、增量最小、差异居中
8. **恢复顺序** = 完全→差异→日志（按时间）

---

## 判断速记 ⭐

✓ 三级封锁→两段锁  
✓ 两段锁→可能死锁  
✓ 锁粒度小→并发大  
✓ 推迟更新只记V2  
✓ 即时更新记V1+V2  
✗ 一级防读脏（需二级）  
✗ 二级防不可重复读（需三级）  
✗ 一次加锁会死锁（不会）

---

**考前必记**：ACID、三级封锁对比表、REDO/UNDO区别、备份恢复顺序！
