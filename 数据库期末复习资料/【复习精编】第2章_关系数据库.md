# 数据库第2章 - 关系数据库 【复习精编】

> 整理自数据库期末复习PPT，精炼知识点

---

## 📚 章节概览

- **2.1 关系数据模型**
- **2.2 关系的完整性**
- **2.3 关系代数**

---

## 2.1 关系数据模型

### 🔑 核心概念

**关系数据模型三要素：**
1. **关系数据结构**：二维表
2. **关系操作集合**：集合操作方式（一次一集合）
3. **关系完整性约束**：实体完整性、参照完整性、用户定义完整性

**发展历史：**
- E.F.Codd于1970年提出关系数据理论（1981年获ACM图灵奖）
- 早期代表系统：SystemR（IBM）、INGRES（Berkeley）
- 目前主流：Oracle、MySQL、MS SQL Server、IBM DB2

---

### 📖 基本术语（重要！）

#### 1. 数学基础概念

| 概念 | 定义 | 示例 |
|------|------|------|
| **域(Domain)** | 一组具有相同数据类型的值的集合 | 整数、实数、{'男','女'} |
| **笛卡儿积** | D1×D2×...×Dn={(d1,d2,...,dn)∣di∈Di} | {张金,王银}×{20,21}={(张金,20),(张金,21),(王银,20),(王银,21)} |
| **关系(Relation)** | 笛卡儿积的子集 | 上述笛卡儿积中选出有意义的子集 |

**笛卡儿积基数：** 若Di的基数为mi，则笛卡儿积基数为：m1×m2×...×mn

#### 2. 关系术语对照

| 数学术语 | 关系术语 | 说明 |
|----------|----------|------|
| 关系 | 二维表 | 表名就是关系名 |
| 属性 | 列/字段 | 每列有一个属性名 |
| 值域 | 属性的取值范围 | 不同属性可对应同一值域 |
| 元组 | 行/记录 | 每一行代表一个实体 |
| 分量 | 元组中的一个属性值 | n元关系的元组有n个分量 |

#### 3. 码的概念（重点）

| 概念 | 定义 | 示例 |
|------|------|------|
| **候选码** | 能唯一标识元组的属性组 | 教师表中的(工号)或(身份证号) |
| **主码** | 从候选码中选定的一个 | 选定工号作为主码 |
| **主属性** | 包含在任一候选码中的属性 | 工号、身份证号都是主属性 |
| **非主属性** | 不包含在任一候选码中的属性 | 姓名、性别、职称等 |
| **全码** | 所有属性组成候选码 | 选课(学号,课程号,成绩)中(学号,课程号) |
| **外码(Foreign Key)** | 本关系的属性但是其他关系的主码 | 学生表中的"系号"是系表的主码 |

**外码关系：**
- R：参照关系（包含外码的关系）
- S：被参照关系/目标关系（被引用主码的关系）
- 外码与主码名称可不同，但必须定义在同一域上
- 可存在于同一关系内部（如：学生表中的"班长号"）

#### 4. 其他概念

| 概念 | 定义 |
|------|------|
| **关系模式** | 二维表的结构描述：REL(A1,A2,...,An) |
| **关系模型** | 所有关系模式、属性名和码的汇集 |
| **关系数据库** | 对应一个关系模型的所有关系的集合 |

---

### ⚠️ 关系的性质（考点）

1. **原子性**：元组的每个分量必须是不可分的数据项
   - ❌ 错误：联系方式列包含{手机、固定电话}两个子列

2. **同质性**：每一列的数据类型必须相同
   - ❌ 错误：同一列中既有字符串又有数字

3. **行列无序**：行、列的顺序可任意交换，不改变关系含义

4. **元组唯一性**：任意两个元组不能完全相同

5. **不同列可出自同一域**
   - 例：员工表中的"雇员工号"和"经理工号"都是工号域
   - 注意：同一关系中，不同属性必须有不同属性名

---

## 2.2 关系的完整性

### 🛡️ 三类完整性约束

#### 1. 实体完整性（Entity Integrity）

**规则：** 若属性A是基本关系R的主属性，则属性A**不能取空值**

**要点：**
- 针对基本关系中的**所有主属性**
- 空值即"不知道"或"无意义"
- 意义：主码用于唯一标识实体，若为空则实体不可标识

**示例：**
```
学生(学号, 姓名, 性别, 所在系)
- 学号：不能为空 ✓
- 所在系：可以为空 ✓

选课(学号, 课程号, 成绩)
- 学号：不能为空 ✓
- 课程号：不能为空 ✓
- 成绩：可以为空 ✓
```

#### 2. 参照完整性（Referential Integrity）

**规则：** 若属性F是基本关系R的外码，与基本关系S的主码Ks相对应，则R中每个元组在F上的取值必须：
- **(1) 取空值**（F的每个属性均为空）
- **(2) 等于S中某个元组的主码值**

**要点：**
- 外码可以为NULL
- 外码不能取一个不存在的主码值
- 可以存在于关系间，也可以存在于同一关系内部

**示例：**
```
系(系号, 系名)
学生(学号, 姓名, 性别, 系号)

学生表中的系号取值：
✓ NULL（表示未分配系）
✓ D01（系表中存在的系号）
✗ D99（系表中不存在的系号）
```

**同一关系内的参照：**
```
学生(学号, 姓名, 性别, 所在系, 班长号)
- 班长号是外码，参照本表的主码"学号"
```

#### 3. 用户定义的完整性（User-defined Integrity）

**定义：** 针对具体数据库的约束条件，由应用环境决定

**常见约束：**
- 成绩：0-100之间
- 性别：只能取'男'或'女'
- 学号、课号：符合特定编号规则
- 年龄：>0且<150
- 邮箱：符合邮箱格式

---

### 🔍 完整性检查时机

1. **插入操作**：检查是否违反三类完整性
2. **删除操作**：检查是否影响参照完整性
3. **更新操作**：检查修改后是否满足完整性约束

**作用：** 保证数据库中的数据是正确的，提高数据准确度

---

## 2.3 关系代数

### 📐 关系代数概述

**定义：** 用对关系的运算来表达查询的抽象查询语言

**运算三要素：**
- 运算对象：关系
- 运算符：∪、∩、-、×、σ、π、⋈、÷
- 运算结果：关系

---

### 🔢 2.3.1 传统的集合运算

**前提：** 参与运算的两个关系R和S必须是**相容的**
- 属性数目相同（同目）
- 对应属性的域相同

#### 1. 并（Union）：R ∪ S

**定义：** R∪S = {t | t∈R ∨ t∈S}

**含义：** 至少出现在R或S之一中的所有元组

**示例：**
```
G1 = {(002210,01,80), (005220,02,70), (005221,01,65)}
G2 = {(002210,01,80), (005130,02,90)}
G1∪G2 = {(002210,01,80), (005220,02,70), (005221,01,65), (005130,02,90)}
```

#### 2. 差（Difference）：R - S

**定义：** R-S = {t | t∈R ∧ t∉S}

**含义：** 属于R但不属于S的元组

**示例：**
```
G1-G2 = {(005220,02,70), (005221,01,65)}
G2-G1 = {(005130,02,90)}
```

#### 3. 交（Intersection）：R ∩ S

**定义：** R∩S = {t | t∈R ∧ t∈S}

**含义：** 同时出现在R和S中的元组

**等价表示：** R∩S = R - (R - S)

**示例：**
```
G1∩G2 = {(002210,01,80)}
```

#### 4. 广义笛卡儿积：R × S

**定义：** R×S = {<tr,ts> | tr∈R ∧ ts∈S}

**特点：**
- 若R有r个属性、m个元组，S有s个属性、n个元组
- 则R×S有(r+s)个属性、m×n个元组

**示例：**
```
S = {(002210,王雪莲), (050220,陈韬), (005221,袁更旭)}  [3个元组]
G = {(002210,01,80), (005220,02,70), (005221,01,65)}  [3个元组]
S×G 共有 3×3=9 个元组
```

---

### 🎯 2.3.2 专门的关系运算

#### 1. 选择（Selection）：σF(R)

**定义：** σF(R) = {t | t∈R ∧ F(t)='真'}

**含义：** 从关系R中选择满足条件F的元组（**水平分割/行操作**）

**条件F形式：** XθY（θ为比较运算符：=、>、<、≥、≤、≠）

**示例：**
```
σSage<20(Student)            -- 查询年龄小于20的学生
σSsex='男' ∧ Sdept='计算机系'(Student)  -- 查询计算机系的男生
```

#### 2. 投影（Projection）：πA(R)

**定义：** πA(R) = {t[A] | t∈R}

**含义：** 从关系R中选择若干属性列（**垂直分割/列操作**）

**特点：** 
- 选择部分列
- 自动去除重复元组

**示例：**
```
πSname,Sage(Student)    -- 查询学生姓名和年龄
πSdept(Student)         -- 查询所有系名（自动去重）
```

#### 3. 连接（Join）

##### A. θ连接（Theta Join）

**定义：** R ⋈AθB S = {<tr,ts> | tr∈R ∧ ts∈S ∧ tr[A]θts[B]}

**含义：** 从R×S中选取满足tr[A]θts[B]的元组

##### B. 等值连接（Equi Join）

**定义：** θ为"="的连接

**特点：** 结果中会保留两个相同的属性列

##### C. 自然连接（Natural Join）：⋈

**定义：** 特殊的等值连接

**特点：**
1. 要求比较的属性组必须是**相同的属性**
2. 结果中**删除重复的属性列**
3. 从行和列两个角度进行计算

**步骤：**
1. 计算R×S
2. 选择公共属性值相等的元组
3. 去掉重复的属性列

**示例：**
```
学生(学号, 姓名)
成绩(学号, 课程号, 成绩)

学生 ⋈ 成绩  →  (学号, 姓名, 课程号, 成绩)
```

##### D. 外连接（Outer Join）

**三种类型：**

1. **左外连接**：保留左表所有记录，右表不匹配的填NULL
2. **右外连接**：保留右表所有记录，左表不匹配的填NULL  
3. **全外连接**：保留两表所有记录，不匹配的填NULL

**对比：**
```
自然连接：只保留匹配的记录
左外连接：保留左表所有记录 + 匹配记录
```

##### E. 自连接（Self Join）

**定义：** 同一个表的两个副本之间的连接

**应用：** 查询"至少选修了2门课程的学生学号"
```
选课(学号, 课程号, 成绩)
σSC1.学号=SC2.学号 ∧ SC1.课程号≠SC2.课程号(SC1 × SC2)
```

#### 4. 除法（Division）：R ÷ S

**定义：** R(X,Y) ÷ S(Y,Z) = {tr[X] | tr∈R ∧ πY(S)⊆YX}

**含义：** R中X分量值x的象集YX包含S在Y上投影的集合

**应用场景：** 查询涉及"全部"的问题

**关键概念 - 象集：**
- 给定关系R(X,Y)，X的某个值x对应的Y的所有值称为x的象集Yx

**示例：**
```
选课SC(学号, 课程号)
课程C(课程号, 课程名)

SC ÷ C  →  查询选修了全部课程的学生学号

学号1001的象集：{C1, C2, C3}
课程投影：{C1, C2, C3}
因为象集包含所有课程，所以1001在结果中
```

---

### 💡 2.3.3 关系代数表达式应用

#### 查询表达式一般形式

```
π属性列表(σ条件(关系1 ⋈ 关系2 ⋈ ... ⋈ 关系n))
```

#### 编写方法步骤

1. **确定涉及的关系**
2. **执行笛卡儿积或自然连接** → 得到大表
3. **选择操作（σ）** → 水平分割（筛选行）
4. **投影操作（π）** → 垂直分割（选择列）

#### 特殊情况

- 查询涉及**"否定"** → 使用**差运算（-）**
- 查询涉及**"全部"** → 使用**除法运算（÷）**

---

### 📝 典型查询示例

#### 示例1：简单查询
```
检索所有规格的"护套绝缘电线"的物资编号、库存数量及库存地点
πmat_num,warehouse,amount(σmat_name='护套绝缘电线'(Stock))
```

#### 示例2：多条件查询
```
检索规格为BVV-120的护套绝缘电线的物资编号、库存数量及库存地点
πmat_num,warehouse,amount(σmat_name='护套绝缘电线' ∧ speci='BVV-120'(Stock))
```

#### 示例3：连接查询
```
检索项目号为"20100015"的抢修项目所使用的物资名称
πmat_name(σprj_num='20100015'(Stock ⋈ Out_stock))
```

#### 示例4：否定查询（使用差运算）
```
检索不用护套绝缘电线的所有抢修项目编号
πprj_num(Salvaging) - πprj_num(σmat_name='护套绝缘电线'(Stock ⋈ Out_stock))
```

#### 示例5："或"条件查询
```
检索使用了物资编号为m001或m002的抢修工程号
πprj_num(σmat_num='m001' ∨ mat_num='m002'(Out_stock))
```

#### 示例6："且"条件查询（自身笛卡儿积）
```
检索同时使用了物资编号为m001和m002的抢修工程号
π1(σ1=6 ∧ 2='m001' ∧ 7='m002'(Out_stock × Out_stock))
```

#### 示例7：除法查询（"全部"）
```
检索被所有抢修工程都使用了的物资编号及物资名称、规格
πmat_num,mat_name,speci(Stock ⋈ (πprj_num,mat_num(Out_stock) ÷ πprj_num(Salvaging)))
```

#### 示例8：包含关系查询
```
检索所用物资包含抢修工程20100016所用物资的抢修工程号
πprj_num,mat_num(Out_stock) ÷ πmat_num(σprj_num='20100016'(Out_stock))
```

---

## 🎓 重点总结

### 必须掌握的概念
✅ 关系、元组、属性、域、候选码、主码、外码  
✅ 三类完整性约束及其检查规则  
✅ 八种关系代数运算符及其含义  
✅ 自然连接 vs 等值连接 vs 外连接的区别  
✅ 除法运算的应用场景  

### 常见考点
⭐ 给定关系模式，识别主码、外码  
⭐ 判断是否违反完整性约束  
⭐ 给定查询需求，写出关系代数表达式  
⭐ 给定关系代数表达式，说明查询含义  
⭐ 计算关系代数运算的结果  

### 易错点
⚠️ 主属性 ≠ 主码（主属性包含在任一候选码中）  
⚠️ 外码可以为NULL，但不能是不存在的值  
⚠️ 自然连接会去除重复列，等值连接不会  
⚠️ 投影操作会自动去重  
⚠️ 除法运算用于"全部"类查询  

---

## 📌 复习建议

1. **理解概念**：熟记术语定义和区别
2. **掌握运算**：每种运算符的含义、特点、应用场景
3. **多做练习**：关系代数表达式的编写和计算
4. **总结规律**：不同查询类型对应的运算符组合
5. **注意细节**：完整性约束的检查时机和规则

---

**祝复习顺利！🎉**

