# 考场精简 - 第4章 存储过程与编程

## 一、MySQL变量详解

### 局部变量
局部变量只能在BEGIN和END语句块中使用,比如存储过程中的BEGIN和END语句块,作用域仅限于该语句块。局部变量使用DECLARE语句定义,可以用DEFAULT说明默认值。

定义局部变量例子：declare m_amount int default 0;

局部变量赋值方式一：set m_amount = 5;

局部变量赋值方式二：select amount into m_amount from stock where mat_num='m001';

### 用户变量
MySQL中用户变量不用提前申明,直接用@变量名使用即可,作用域为当前连接。

用户变量赋值方式一：set @m_amount=5; 或者 set @m_amount :=5;

用户变量赋值方式二：select @m_amount :=5; 或者 select @m_amount:= amount from stock where mat_num='m001';

注意使用set时可以用等号或冒号等号两种赋值符号,使用select时必须用冒号等号赋值符号。

### 会话变量
服务器为每个连接的客户端维护一系列会话变量,作用域仅限于当前连接,即每个连接中的会话变量是独立的。

显示所有会话变量：show session variables;

设置会话变量的三种方式：set session auto_increment_increment=1; 或 set @@session.auto_increment_increment=2; 或 set auto_increment_increment=3;

当省略session关键字时默认缺省为session,即设置会话变量的值。

查询会话变量的三种方式：select @@auto_increment_increment; 或 select @@session.auto_increment_increment; 或 show session variables like '%auto_increment_increment%';

关键字session也可用关键字local替代,例如：set @@local.auto_increment_increment=1; 和 select @@local.auto_increment_increment;

### 全局变量
全局变量影响服务器整体操作,当服务启动时将所有全局变量初始化为默认值。要想更改全局变量必须具有super权限,作用域为server的整个生命周期。

显示所有全局变量：show global variables;

设置全局变量的两种方式：set global sql_warnings=ON; 或 set @@global.sql_warnings=OFF; 注意global不能省略。

查询全局变量的两种方式：select @@global.sql_warnings; 或 show global variables like '%sql_warnings%';

## 二、注释语句

### 单行注释方式一
两个减号加空格后面添加注释内容,注意减号后必须有一个空格。例如：SELECT * FROM table -- 这是一个单行注释

### 单行注释方式二
井号后面添加注释内容,无需空格。例如：SELECT * FROM table # 这是一个单行注释

### 多行注释
斜杠星号和星号斜杠之间添加注释内容,可以跨越多行。例如：SELECT * FROM table /* 这是一个多行注释 */

### 内联注释
斜杠星号感叹号和星号斜杠这种注释称为内联注释,通常用于指定特定MySQL版本执行的代码。例如：SELECT * FROM table /*!50110 WHERE condition */

## 三、流程控制语句

### BEGIN和END语句
使用BEGIN和END语句可以将多条SQL语句封装起来形成一个语句块,使这些语句作为一个整体执行。语法形式是BEGIN开头,中间写语句,最后END结尾。

### IF和ELSE语句
语法形式：IF 条件表达式 THEN 语句 ELSE 语句 END IF

执行过程为如果条件表达式为真则执行IF后面的语句或语句块,如果条件表达式为假则执行ELSE后面的语句或语句块。

考试例题：在电力抢修工程数据库中,如果Stock表中m001物资的库存量低于10就显示文本库存不足需要补货,否则显示库存充足。

DECLARE stock_amount INT;
SELECT amount INTO stock_amount FROM Stock WHERE mat_num = 'm001';
IF stock_amount < 10 THEN
    SELECT '库存不足,需要补货';
ELSE
    SELECT '库存充足';
END IF;

注意该语句段可以在存储过程中使用。

### WHILE循环语句
语法形式：WHILE 条件 DO 语句 END WHILE

考试例题：创建表CREATE TABLE numbers ( id INT AUTO_INCREMENT PRIMARY KEY, value INT );

下列语句段可以在存储过程中使用：
DECLARE counter INT DEFAULT 1;
WHILE counter <= 10 DO
    INSERT INTO numbers (value) VALUES (counter);
    SET counter = counter + 1;
END WHILE;

### CASE语句格式一
CASE后面跟表达式,然后WHEN条件表达式THEN表达式,可以有多个WHEN,最后ELSE表达式,用END结束。

考试例题：用CASE语句格式一实现在对stock表的查询中,当仓库号的值是供电局1号仓库、供电局2号仓库、供电局3号仓库时分别返回北京、上海、广州,否则返回未知。

SELECT mat_num,mat_name,speci,amount,unit,
    CASE warehouse
        WHEN '供电局1#仓库' THEN '北京'
        WHEN '供电局2#仓库' THEN '上海'
        WHEN '供电局3#仓库' THEN '广州'
        ELSE '未知'
    END AS warehouse
FROM Stock;

### CASE语句格式二
CASE后面不跟表达式,直接WHEN条件表达式THEN表达式,可以有多个WHEN,最后ELSE表达式,用END结束。

考试例题：用CASE语句格式二实现上面的例子。

SELECT mat_num,mat_name,speci,amount,unit,
    CASE
        WHEN warehouse='供电局1#仓库' THEN '北京'
        WHEN warehouse='供电局2#仓库' THEN '上海'
        WHEN warehouse='供电局3#仓库' THEN '广州'
        ELSE '未知'
    END as warehouse
FROM Stock;

### CASE语句应用例题
学生数据库查询各系平均成绩：

select sdept,
    avg(case when cname='数据结构' then grade end) 数据结构,
    avg(case when cname='数据库原理' then grade end) 数据库原理,
    avg(case when cname='操作系统' then grade end) 操作系统
from student s inner join Sc on s.Sno=SC.Sno
    inner join course c on SC.Cno=c.cno
group by Sdept

## 四、存储过程基本概念

存储过程是存储在数据库服务器中的一组编译成单个执行计划的SQL语句。使用Transact-SQL语言编程的过程中,可以将某些需要多次调用以实现某个特定任务的代码段编写成一个过程,将其保存在数据库中,并由SQL Server服务器通过过程名调用。

存储过程在创建时被编译和优化,可以包含程序控制流、查询子句、操作子句,还可以接受参数、输出参数、返回单个值或多个结果集。

### 存储过程分类
系统存储过程是SQL Server本身定义的当作命令来执行的一类存储过程,通常以sp下划线为前缀,主要功能是从系统表中获取信息。

用户自定义的存储过程是用户创建并完成某一特定功能的存储过程。

### 存储过程优点
第一运行效率高,提供了在服务器端快速执行SQL语句的有效途径。第二降低了客户机和服务器之间的通信量。第三方便实施企业规则。

## 五、MySQL存储过程创建和管理

### MySQL创建存储过程基本语法
CREATE PROCEDURE 存储过程名(参数列表)
BEGIN
    SQL语句
END

存储过程中的参数列表如果没有参数使用一个空参数列,多个参数之间通过逗号进行分割。参数列表中的每个参数都由输入输出类型、参数名称和参数类型组成,语法如IN或OUT或INOUT加参数名称加类型。其中IN表示输入参数,OUT表示输出参数,INOUT既可以是输入也可以是输出参数。

### 执行存储过程语法
CALL 存储过程名()

### 基本存储过程例题
创建一个最简单的存储过程用于查看Stock表中的所有记录。

DELIMITER &&
CREATE PROCEDURE pro1()
BEGIN
    SELECT * FROM stock;
END

执行存储过程：CALL pro1

### 带输入参数的存储过程例题
创建一个带输入参数的存储过程向Stock表中添加一个新的数据行。

DELIMITER &&
CREATE PROCEDURE pro2(mno char(8),mname varchar(50),mspeci varchar(20))
BEGIN
    INSERT INTO Stock(mat_num,mat_name,speci)
    VALUES(mno,mname,mspeci);
END

执行存储过程：CALL pro2 ('m030','护套绝缘电线','BVV-35');

### 带输出参数的存储过程例题
OUT用于指明参数为输出参数,可以返回到调用存储过程的语句或其他存储过程中。

创建一个存储过程根据输入的抢修工程项目号统计其领取物资的总数量并要求输出。

DELIMITER &&
CREATE PROCEDURE pro3(pn char(8), OUT total int)
BEGIN
    SELECT sum(amount) into total
    FROM out_stock
    WHERE prj_num=pn;
END

执行：call pro3('20100015', @total); 然后 select @total;

### 带INOUT参数的存储过程例题
创建一个存储过程根据输入的工程部门及起止时间段汇总该部门在对应时间段内所参与抢修的工程项目总数以及领取物资的总成本并要求输出。

DELIMITER &&
CREATE PROCEDURE pro4(INOUT depart varchar(50),start_date datetime, end_date datetime, OUT count_prj int ,out sum_cost decimal(18,2))
BEGIN
    SELECT COUNT(distinct salvaging.prj_num),sum(out_stock.amount*unit) into count_prj,sum_cost
    FROM salvaging INNER JOIN out_stock on out_stock.prj_num=salvaging.prj_num
        INNER JOIN stock on out_stock.mat_num =Stock.mat_num
    WHERE department = depart
        and get_date between start_date and end_date;
END

执行：set @depart='工程2部'; 然后 call pro4(@depart,'2011-1-1','2011-1-31',@prjcounts,@sumcosts); 最后 select @depart,@prjcounts,@sumcosts;

### 嵌套调用存储过程例题
嵌套调用存储过程查看使用抢修物资总数最多的工程项目信息。

DELIMITER &&
CREATE PROCEDURE pro5(OUT prj_no char(8))
BEGIN
    SELECT prj_num into prj_no
    FROM out_stock
    GROUP BY prj_num
    ORDER BY SUM(amount) DESC
    LIMIT 1;
END

DELIMITER &&
CREATE PROCEDURE pro6()
BEGIN
    DECLARE prj_id char(8);
    call pro5(@prj_id);
    SELECT *
    FROM Salvaging
    WHERE prj_num=@prj_id;
End

执行存储过程：call pro6();

### 在存储过程中使用游标
查询语句可能返回多条记录,如果数据量非常大需要在存储过程和函数中使用游标来逐条读取查询结果集中的记录。游标必须在程序之前且在变量和条件之后声明,而且游标使用完成一定要关闭。

声明游标语法：DECLARE 游标名 CURSOR FOR SELECT语句;

打开游标语法：OPEN 游标名;

使用游标语法：FETCH 游标名 INTO 参数名1,参数名2等;

其中参数名表示将游标中的SELECT语句查询出来的信息存入到该参数中,参数名必须在声明游标之前就已经定义。

关闭游标语法：CLOSE 游标名;

考试例题：在存储过程中使用游标把stock表中所有的仓库名称连接为一个字符串并进行显示输出。

DELIMITER &&
CREATE PROCEDURE pro7()
BEGIN
    DECLARE done INT DEFAULT 0;
    DECLARE whname varchar(10) DEFAULT '';
    DECLARE allname varchar(1000) DEFAULT '';
    DECLARE cur1 CURSOR FOR SELECT distinct warehouse FROM stock;
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done=1;
    OPEN cur1;
    REPEAT
        FETCH cur1 INTO whname;
        IF NOT done THEN
            SET allname = CONCAT(allname,whname);
        END IF;
    UNTIL done END REPEAT;
    CLOSE cur1;
    SELECT allname;
END

执行存储过程：call pro7();

### 查看存储过程
SHOW STATUS语句可以查看存储过程的状态。基本语法结构是SHOW PROCEDURE STATUS LIKE 模式; 其中LIKE模式为可选项用来匹配存储过程名称,如果不指定LIKE子句则查询当前数据库下的所有存储过程。例如：SHOW PROCEDURE STATUS like 'pro_';

注意SHOW STATUS语句只能查看存储过程的名称、类型、谁定义的、创建和修改时间、字符编码等信息,不能查询存储过程或函数的具体定义。

SHOW CREATE语句也可以查看存储过程的状态。基本语法结构是SHOW CREATE PROCEDURE 存储过程名; 例如：SHOW CREATE PROCEDURE pro1;

注意SHOW CREATE语句查询结果显示了存储过程的定义、字符集等信息。

### 修改和删除存储过程
修改存储过程的语句是：ALTER PROCEDURE 存储过程名(参数列表) BEGIN SQL语句 END

删除存储过程的语句是：DROP PROCEDURE存储过程名

## 六、SQL Server存储过程创建和管理

### SQL Server创建存储过程基本语法
CREATE PROCEDURE 存储过程名
    参数列表,格式为@参数 数据类型,可选默认值,可选OUTPUT
    WITH可选项如RECOMPILE或ENCRYPTION或两者
    FOR REPLICATION可选
AS
    SQL语句

### 基本存储过程例题
创建一个最简单的存储过程用于查看Stock表中的所有记录。

CREATE PROCEDURE exp1
AS
    SELECT *
    FROM Stock

执行存储过程：EXECUTE exp1 或者 EXEC exp1

### 带输入参数的存储过程例题
创建一个存储过程通过输入的仓库名称显示出该仓库的所有库存物资信息。

CREATE PROCEDURE exp
    @warehousename varchar(50)
AS
    SELECT *
    FROM stock
    WHERE warehouse=@warehousename

执行存储过程：exec exp '供电局1#仓库'

另一个带输入参数例题：创建一个带输入参数的存储过程向Stock表中添加一个新的数据行。

CREATE PROCEDURE exp2
    @mno char(8), @mname varchar(50), @mspeci varchar(20)
AS
    INSERT INTO Stock(mat_num,mat_name,speci)
    VALUES(@mno,@mname,@mspeci)

执行存储过程可以用三种方式：EXECUTE exp2 'm030','护套绝缘电线','BVV-35' 或 EXECUTE exp2 @mno='m030', @mname='护套绝缘电线', @mspeci='BVV-35' 或 EXECUTE exp2 @mname='护套绝缘电线', @mspeci='BVV-35', @mno='m030'

### 确保创建成功的注意事项
为了确保Create命令能成功执行可以在Create Procedure之前执行如下语句：IF EXISTS (SELECT name FROM sysobjects WHERE name='exp2' and type='P') DROP PROCEDURE exp2 然后 GO

### 带默认参数的存储过程例题
创建一个带默认参数的存储过程,通过传递的参数显示物资的名称、规格、项目名称、是否按期完工等信息,如果没有提供参数则使用预设的默认值。

CREATE PROCEDURE exp4
    @mname varchar(50)='%绝缘%', @pno char(8)='20110001'
AS
    SELECT mat_name,speci,prj_name,prj_status
    FROM stock, salvaging, out_stock
    WHERE stock.mat_num=out_stock.mat_num
        and salvaging.prj_num=out_stock.prj_num
        and mat_name like @mname
        and salvaging.prj_num=@pno

执行创建的存储过程exp4可以用多种方式：EXECUTE exp4 或 EXECUTE exp4 '%绝缘电线' 或 EXECUTE exp4 @pno='20110002' 或 EXECUTE exp4 '护套绝缘电线','20110002'

### 带输出参数的存储过程例题
OUTPUT指明输出参数可以返回到调用存储过程的批处理或其他存储过程中。

创建一个存储过程根据输入的抢修工程项目号统计其领取物资的总数量并要求输出。

CREATE PROCEDURE exp4
    @pn char(8), @sum int OUTPUT
AS
    SELECT @sum=sum(amount)
    FROM Out_stock
    WHERE prj_num=@pn

执行：DECLARE @total int 然后 EXECUTE exp4 '20110001', @total OUTPUT 最后 PRINT '该项目领取物资总量为：'+ CAST(@total AS varchar(20))

另一个带输出参数例题：创建一个存储过程根据输入的工程部门及起止时间段汇总该部门在对应时间段内所参与抢修的工程项目总数以及领取物资的总成本并要求输出。

CREATE PROCEDURE exp5
    @department varchar(50),@start_date datetime,@end_date datetime,
    @count_prj int OUTPUT, @sum_cost decimal(18,2) OUTPUT
AS
    select @count_prj=COUNT(DISTINCT out_stock.prj_num),
        @sum_cost=SUM(Out_stock.amount*Stock.unit)
    FROM salvaging,out_stock,stock
    WHERE out_stock.prj_num =salvaging.prj_num
        and out_stock.mat_num =Stock.mat_num
        and department = @department
        and get_date between @start_date and @end_date

执行：DECLARE @prjcounts int, @sumcosts decimal(18,2) 然后 EXEC exp5 '工程2部','2011-1-1','2011-1-31', @prjcounts OUTPUT, @sumcosts OUTPUT 最后 PRINT '该部门参与抢修工程项目'+ CAST(@prjcounts AS varchar(20))+'个,总成本为'+CAST(@sumcosts AS varchar(20))

### 嵌套调用存储过程例题
嵌套调用存储过程查看使用抢修物资总数最多的工程项目信息。

CREATE PROCEDURE exp6
    @prj_no char(8) OUTPUT
AS
    SELECT TOP 1 @prj_no=prj_num
    FROM out_stock
    GROUP BY prj_num
    ORDER BY SUM(amount) DESC
GO

CREATE PROCEDURE exp7
AS
    DECLARE @prj_id char(8)
    EXEC exp6 @prj_id OUTPUT
    SELECT *
    FROM Salvaging
    WHERE prj_num=@prj_id
GO

执行存储过程：EXECUTE exp7

### 修改和删除存储过程
修改存储过程的语句是：ALTER PROCEDURE 存储过程名,参数列表格式为@参数 数据类型可选默认值可选OUTPUT,WITH可选项如RECOMPILE或ENCRYPTION或两者,FOR REPLICATION可选,AS后面是SQL语句。

删除存储过程的语句是：DROP PROCEDURE 存储过程名

## 考场速记口诀

变量四类记心间：局部用户会话全局各有权限范围。

局部DECLARE需定义,用户@符号直接用,会话SESSION或LOCAL,全局GLOBAL权限重。

IF判断真假分支,WHILE循环条件控,CASE分支多选择,BEGIN END成块用。

存储过程效率高,减少通信规则巧,IN输入OUT输出,INOUT双向要记牢。

游标逐条读记录,声明打开取关闭,FETCH INTO存变量,循环处理要仔细。

查看SHOW STATUS和CREATE,修改ALTER删DROP,MySQL用CALL来执行,SQL Server用EXEC调。

带参灵活多变化,默认参数可省略,嵌套调用功能强,输出参数必OUTPUT标。

