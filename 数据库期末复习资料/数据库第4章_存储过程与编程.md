# 数据库第4章 - 存储过程与编程

> 整理自数据库期末复习PPT

---

## 4.1 编程语法.pptx


### 幻灯片 1

数据库原理


### 幻灯片 2

第四章    数据库编程
	4.1 My SQL  编程语法
	4.2 存储过程


### 幻灯片 3

4.1 MySQL 编程语法
4.1.1 变量
mysql变量可分为两大类：系统变量和用户变量
细化为四种类型：局部变量、用户变量、会话变量、全局变量。
1. 局部变量：只能用在begin/end语句块中，比如存储过程中的begin/end语句块。
其作用域仅限于该语句块。
-- declare语句专门用于定义局部变量，可以使用default来说明默认值 
    declare m_amount  int default  0; 
-- 局部变量的赋值方式一 ：set m_amount =5;
-- 局部变量的赋值方式二 ：
select amount into m_amount from stock where mat_num=‘m001';


### 幻灯片 4

4.1 My SQL 编程语法
4.1.1 变量
2．用户变量  mysql中用户变量不用提前申明，在用的时候直接用“@变量名”使用就可以了。其作用域为当前连接。

 -- 第一种用法，使用set时可以用“=”或“:=”两种赋值符号赋值
       set @m_amount=5;  或   set @m_amount :=5; 
-- 第二种用法，使用select时必须用“:=”赋值符号赋值
  select @m_amount :=5; 
select @m_amount:= amount  from stock where mat_num=‘m001';


### 幻灯片 5

4.1 My SQL 编程语法
4.1.1 变量
3．会话变量  服务器为每个连接的客户端维护一系列会话变量。
                    其作用域仅限于当前连接，即每个连接中的会话变量是独立的。
-- 显示所有的会话变量： show session variables; 
-- 设置会话变量的值的三种方式 ：
set session auto_increment_increment=1;
 set @@session.auto_increment_increment=2;
 set auto_increment_increment=3; 
-- 当省略session关键字时，默认缺省为session，即设置会话变量的值
 -- 查询会话变量的值的三种方式 
    select @@auto_increment_increment; 
    select @@session.auto_increment_increment; 
    show session variables like '%auto_increment_increment%'; -- session关键字可省略 
-- 关键字session也可用关键字local替代 set @@local.auto_increment_increment=1; select @@local.auto_increment_increment;


### 幻灯片 6

4.1 My SQL 编程语法
4.1.1 变量
3．会话变量  
-- 查询会话变量的值的三种方式 
    select @@auto_increment_increment; 
    select @@session.auto_increment_increment; 
    show session variables like '%auto_increment_increment%'; -- session关键字可省略 
-- 关键字session也可用关键字local替代
    set @@local.auto_increment_increment=1; 
    select @@local.auto_increment_increment;


### 幻灯片 7

4.1 My SQL 编程语法
4.1.1 变量
4．全局变量  全局变量影响服务器整体操作，当服务启动时，它将所有全局变量初始化为默认值。要想更改全局变量，必须具有super权限。其作用域为server的整个生命周期。
 -- 显示所有的全局变量： show global variables;
 -- 设置全局变量的值的两种方式 
     set global sql_warnings=ON; -- global不能省略 
    set @@global.sql_warnings=OFF; 
-- 查询全局变量的值的两种方式 ：
      select @@global.sql_warnings; 
      show global variables like '%sql_warnings%';


### 幻灯片 8

4.1 SQL Server编程语法
4.1.2 注释语句
--单行注释‌
--：在 -- 后面添加注释内容，注意 -- 后必须有一个空格。
例如：SELECT * FROM table -- 这是一个单行注释 
#：在 # 后面添加注释内容，无需空格。
例如：  SELECT * FROM table # 这是一个单行注释 
--‌多行注释‌
/* ... */：在 /* 和 */ 之间添加注释内容，可以跨越多行。
例如：SELECT * FROM table /* 这是一个 多行注释 */ 
--内联注释‌
/*! ... */：这种注释称为内联注释，通常用于指定特定 MySQL 版本执行的代码。例如： 
   SELECT * FROM table /*!50110 WHERE condition */


### 幻灯片 9

4.1 SQL Server编程语法
4.1.3 流程控制语句
1．BEGIN…END语句
语法形式：
 BEGIN
   语句
    ．．．．．．    
 END

        使用BEGIN…END语句可以将多条SQL语句封装起来，形成一个语句块，使这些语句作为一个整体执行。
2．IF…ELSE语句
语法形式：
  IF 条件表达式  THEN
     语句
 [ELSE 
      语句 ]
  END IF

执行过程为：如果条件表达式为真，则执行IF后面的语句或语句块，如果条件表达式为假，则执行ELSE后面的语句或语句块。


### 幻灯片 10

4.1 SQL Server编程语法
4.1.3 流程控制语句
【例4.1】在电力抢修工程数据库中，如果Stock表中m001物资的库存量低于10，就显示文本：“库存不足，需要补货”；否则显示“库存充足”。
DECLARE stock_amount INT;
SELECT amount INTO stock_amount FROM Stock WHERE mat_num = ‘m001’; 
IF stock_amount < 10 THEN 
    SELECT '库存不足，需要补货'; 
ELSE 
    SELECT '库存充足'; 
END IF;
注意：该语句段可以在存储过程中使用


### 幻灯片 11

4.1 SQL Server编程语法
4.1.3 流程控制语句
3．WHILE循环语句   
语法形式：   WHILE <条件> DO
                         [语句]
                      END WHILE 
【例4.2】创建如下表：
CREATE TABLE numbers ( id INT AUTO_INCREMENT PRIMARY KEY, value INT );
下列语句段可以在存储过程中使用：
DECLARE counter INT DEFAULT 1; 
WHILE counter <= 10  DO
    INSERT INTO numbers (value) VALUES (counter); 
    SET counter = counter + 1; 
END WHILE;


### 幻灯片 12

4.1 SQL Server编程语法
4.1.3 流程控制语句
6.CASE语句
    根据条件选定某一候选值返回。

(1) 格式一
   CASE <表达式>
       WHEN <条件表达式1> THEN <表达式1> 
       [[WHEN <条件表达式2> THEN <表达式2>][…]]
       [ELSE <表达式n>]
   END


### 幻灯片 13

4.1 SQL Server编程语法
4.1.3 流程控制语句
【例4.4】用CASE语句格式一实现：在对stock表的查询中，当仓库号的值是“供电局1#仓库”、“供电局2#仓库”、“供电局3#仓库”时分别返回“北京”、“上海”、“广州”，否则返回“未知”。
SELECT mat_num,mat_name,speci,amount,unit,  
    CASE warehouse      
     WHEN '供电局1#仓库' THEN '北京' 
     WHEN '供电局2#仓库' THEN '上海‘
     WHEN '供电局3#仓库' THEN '广州' 
   ELSE '未知'   
   END AS warehouse
FROM     Stock;


### 幻灯片 14

4.1 SQL Server编程语法
4.1.3 流程控制语句
(2) 格式二       CASE
                         WHEN <条件表达式1> THEN <表达式1>
                         [[WHEN <条件表达式2> THEN <表达式2>][…]]
                         [ELSE <表达式n>]
                     END
【例4.5】用CASE语句格式二实现例4.4。
SELECT mat_num,mat_name,speci, amount,unit, 
        






FROM Stock
CASE 
     WHEN warehouse='供电局1#仓库' THEN '北京'
     WHEN warehouse='供电局2#仓库' THEN '上海'
     WHEN warehouse='供电局3#仓库' THEN '广州'
     ELSE '未知'
END  as warehouse


### 幻灯片 15

4.1 SQL Server编程语法
4.1.3 流程控制语句
例：学生数据库 
select s.Sno,Sname,Sdept,c.cno,cname,Grade,Ccredit 
from student s 
inner join sc on s.Sno=sc.Sno inner join course c on sc.Cno=c.cno


### 幻灯片 16

4.1 SQL Server编程语法
4.1.3 流程控制语句
select sdept,
  avg(case when cname='数据结构' then grade end ) 数据结构,
 avg(case when cname='数据库原理' then grade end) 数据库原理,
 avg(case when cname='操作系统' then grade end) 操作系统
  from student s  inner  join Sc on s.Sno=SC.Sno 
             inner join  course c  on  SC.Cno=c.cno
  group by Sdept
希望得到如下查询结果(各系平均成绩)：


### 幻灯片 17

小结
变量
显示信息
注释语句
批处理
流程控制语句
谢谢观看！

---

## 4.2存储过程.pptx


### 幻灯片 1

数据库原理


### 幻灯片 2

第四章    存储过程、触发器和数据库完整性

	4.1 SQL Server 编程语法
	4.2 存储过程
	4.3 触发器        
        4.4 数据库的完整性


### 幻灯片 3

4.2 存储过程
4.2.1 存储过程的基本概念
存储在数据库服务器中的一组编译成单个执行计划的SQL语句。使用Transact-SQL语言编程的过程中，可以将某些需要多次调用以实现某个特定任务的代码段编写成一个过程，将其保存在数据库中，并由SQL Server服务器通过过程名调用，称为存储过程。
          存储过程在创建时被编译和优化，可以包含程序控制流、查询子句、操作子句，还可以接受参数、输出参数、返回单个值或多个结果集。
分类：
     系统存储过程：SQL Server本身定义的，当作命令来执行的一类存储过程，通常以sp_为前缀，一般以sp_为前缀，主要功能是从系统表中获取信息。
     用户自定义的存储过程：用户创建并完成某一特定功能的存储过程。


### 幻灯片 4

4.2 存储过程
4.2.1 存储过程的基本概念
优点：1) 运行效率高，提供了在服务器端快速执行SQL语句的有效途径。
          2) 降低了客户机和服务器之间的通信量。 
          3) 方便实施企业规则。


### 幻灯片 5

4.2 存储过程
4.2.2 创建和管理MySQL存储过程
MySQL中创建存储过程的语句格式为：
CREATE PROCEDURE 存储过程名(参数列表)
BEGIN
     SQL语句
END

存储过程中的参数列表：如果没有参数，使用一个空参数列()；多个参数之间通过逗号进行分割。参数列表中的每个参数都由输入输出类型、参数名称和参数类型组成，语法如：[IN | OUT | INOUT] 参数名称  类型
其中：IN表示输入参数；OUT表示输出参数；INOUT即可以是输入，也可以是输出参数。


### 幻灯片 6

4.2 存储过程
4.2.2 创建和管理MySQL存储过程
1．基本存储过程
【例4.5】创建一个最简单的存储过程，用于查看Stock表中的所有记录。
  DELIMITER &&
   CREATE PROCEDURE pro1()
   BEGIN
       SELECT * FROM  stock;
   END
执行存储过程:
CALL[@<状态变量>=] 存储过程名()
[@<参数>=] {<值>|@<变量>}…]
执行存储过程:
     CALL  pro1


### 幻灯片 7

4.2 存储过程
4.2.2 创建和管理MySQL存储过程
2．带输入参数的存储过程
在存储过程中还可以使用输入参数，通过存储过程每次执行时使用不同输入参数值，实现其灵活性。
【例4.6】创建一个带输入参数的存储过程，向Stock表中添加一个新的数据行。
DELIMITER &&
CREATE PROCEDURE pro2(mno char(8),mname varchar(50),mspeci varchar(20))
BEGIN
    INSERT INTO Stock(mat_num,mat_name,speci)
    VALUES(mno,mname,mspeci);
END
执行存储过程:
   CALL  pro2 ('m030','护套绝缘电线','BVV-35');


### 幻灯片 8

4.2 存储过程
4.2.2 创建和管理MySQL存储过程
3．带输出参数的存储过程
OUT用于指明参数为输出参数，可以返回到调用存储过程的语句或其他存储过程中。
【例4.7】创建一个存储过程，根据输入的抢修工程项目号统计其领取物资的总数量，并要求输出。
    DELIMITER &&
    CREATE PROCEDURE pro3(pn char(8), OUT total int) 
    BEGIN
        SELECT sum(amount)  
        FROM out_stock 
        WHERE prj_num=        ;
    END
pn
into total
执行：
   call pro3('20100015', @total);
   select @total;


### 幻灯片 9

4.2 存储过程
4.2.2 创建和管理MySQL存储过程
【例4.10】 创建一个存储过程，根据输入的工程部门及起止时间段，汇总该部门在对应时间段内所参与抢修的工程项目总数以及领取物资的总成本，并要求输出。
BEGIN
SELECT  

FROM salvaging INNER JOIN out_stock on out_stock.prj_num=salvaging.prj_num  
     INNER JOIN stock on  out_stock.mat_num =Stock.mat_num 
WHERE department =
      and get_date between                      and                      ;
END
COUNT(distinct salvaging.prj_num),sum(out_stock.amount*unit)
depart
DELIMITER &&
CREATE PROCEDURE pro4(INOUT depart varchar(50),start_date datetime, end_date datetime, OUT count_prj int ,out sum_cost decimal(18,2))
into count_prj,sum_cost
start_date
end_date


### 幻灯片 10

4.2 存储过程
4.2.2 创建和管理MySQL存储过程
执行存储过程pro4的语句如下：

set @depart='工程2部';
call pro4(@depart,'2011-1-1','2011-1-31',@prjcounts,@sumcosts);
select @depart,@prjcounts,@sumcosts;


### 幻灯片 11

4.2 存储过程
4.2.2 创建和管理MySQL存储过程
5．嵌套调用存储过程
【例4.9】 嵌套调用存储过程，查看使用抢修物资总数最多的工程项目信息。
DELIMITER &&
CREATE PROCEDURE pro5(OUT prj_no char(8))
BEGIN
  SELECT prj_num into prj_no
  FROM out_stock
  GROUP BY prj_num
  ORDER BY SUM(amount) DESC 
  LIMIT 1;
END
DELIMITER &&
CREATE PROCEDURE pro6()
BEGIN
 DECLARE prj_id char(8);
 call pro5(@prj_id);
 SELECT *
 FROM Salvaging
 WHERE prj_num=@prj_id;
End
执行存储过程：call pro6();


### 幻灯片 12

4.2 存储过程
6．在存储过程中定义和使用游标
查询语句可能返回多条记录，如果数据量非常大，需要在存储过程和函数中使用游标来逐条读取查询结果集中的记录。游标必须在程序之前且在变量和条件之后声明，而且游标使用完成一定要关闭。
    声明游标：DECLARE 游标名 CURSOR FOR SELECT语句;
 打开游标：OPEN 游标名;
    使用游标：FETCH 游标名 INTO 参数名1[,参数名2…];
其中：参数名表示将游标中的SELECT语句查询出来的信息存入到该参数中，参数名必须在声明游标之前就以及定义。
     关闭游标：CLOSE 游标名;
4.2.2 创建和管理MySQL存储过程


### 幻灯片 13

13
4.2 存储过程
4.2.2 创建和管理MySQL存储过程
【例4.10】在存储过程中使用游标，把stock表中所有的仓库名称连接为一个字符串，并进行显示输出。
DELIMITER &&
CREATE PROCEDURE pro7()
BEGIN
   DECLARE done INT DEFAULT 0;
   DECLARE whname varchar(10) DEFAULT '';  
   DECLARE allname varchar(1000) DEFAULT '';  
   DECLARE cur1 CURSOR FOR SELECT distinct warehouse FROM stock;
   DECLARE CONTINUE HANDLER FOR NOT FOUND SET done=1;


### 幻灯片 14

14
4.2 存储过程
4.2.2 创建和管理MySQL存储过程
OPEN cur1;
   REPEAT 
        FETCH cur1 INTO whname;
        IF NOT done THEN
            SET allname = CONCAT(allname,whname); 
        END IF;
    UNTIL done END REPEAT;
   CLOSE cur1;
   SELECT allname;
END
执行存储过程：call pro7();


### 幻灯片 15

15
4.2 存储过程
4.2.2 创建和管理MySQL存储过程
7．查看存储过程
（1）SHOW STATUS语句可以查看存储过程的状态
基本语法结构：SHOW PROCEDURE STATUS [LIKE 'pattern'];
如：SHOW PROCEDURE STATUS like 'pro_';
其中：LIKE 'pattern'为可选项，用来匹配存储过程名称。如果不指定LIKE子句，则查询当前数据库下的所有存储过程。
注：SHOW STATUS语句只能查看存储过程的名称、类型、谁定义的、创建和修改时间、字符编码等信息，不能查询存储过程或函数的具体定义。


### 幻灯片 16

16
4.2 存储过程
4.2.2 创建和管理MySQL存储过程
（2）SHOW CREATE语句也可以查看存储过程的状态
基本语法结构：SHOW CREATE PROCEDURE 存储过程名;
如：SHOW CREATE PROCEDURE pro1;
注：SHOW CREATE语句查询结果显示了存储过程的定义、字符集等信息。


### 幻灯片 17

4.2 存储过程
修改存储过程的语句是：
ALTER PROCEDURE 存储过程名(参数列表)
  BEGIN
     SQL语句
  END

删除存储过程的语句是：
   DROP PROCEDURE存储过程名
4.2.2 创建和管理MySQL存储过程
8．修改和删除存储过程


### 幻灯片 18

4.2 存储过程
4.2.2 创建和管理SQLServer存储过程
创建存储过程的SQL语句格式为：

  CREATE PROCEDURE 存储过程名 [；版本号]
    [ {@参数 数据类型} [ VARYING ] [= 默认值][ OUTPUT ],
       ……]
    [ WITH{RECOMPILE|ENCRYPTION|RECOMPILE,ENCRYPTION}]   [ FOR REPLICATION ] 
   AS 
      SQL语句


### 幻灯片 19

4.2 存储过程
4.2.2创建和管理SQLServer存储过程
1．基本存储过程
【例4.6】创建一个最简单的存储过程，用于查看Stock表中的所有记录。
    CREATE PROCEDURE exp1
    AS
      SELECT * 
      FROM  Stock
执行存储过程:
EXECUTE  [@<状态变量>=] 存储过程名
         [@<参数>=] {<值>|@<变量>}…]
执行存储过程:
     EXECUTE  exp1
或者：
     EXEC  exp1


### 幻灯片 20

4.2 存储过程
4.2.2创建和管理SQLServer存储过程
【例】创建一个存储过程，通过输入的仓库名称显示出该仓库的所有库存物资信息。 
   CREATE PROCEDURE exp 
        @warehousename  varchar(50)
   AS
      SELECT * 
      FROM  stock 
      WHERE warehouse=
执行存储过程:
   exec  exp  '供电局1#仓库'
在存储过程中还可以使用输入参数，通过存储过程每次执行时使用不同输入参数值，实现其灵活性。
2．带参数的存储过程
@warehousename


### 幻灯片 21

4.2 存储过程
4.2.2创建和管理SQLServer存储过程
【例4.7】创建一个带输入参数的存储过程，向Stock表中添加一个新的数据行。
   CREATE PROCEDURE exp2 
    @mno char(8), @mname varchar(50), @mspeci varchar(20)
  AS
    INSERT 
    INTO  Stock(mat_num,mat_name,speci)
    VALUES
(@mno,@mname,@mspeci)
执行存储过程：EXECUTE  exp2 'm030','护套绝缘电线','BVV-35'
或：EXECUTE exp2 @mno='m030', @mname='护套绝缘电线', @mspeci='BVV-35‘
或：EXECUTE exp2 @mname='护套绝缘电线', @mspeci='BVV-35', @mno='m030'


### 幻灯片 22

4.2 存储过程
4.2.2创建和管理SQLServer存储过程
注意:为了确保Create命令能成功执行，可以在Create Procedure之前执行如下语句：
IF EXISTS (SELECT name FROM sysobjects WHERE name='exp2' and type='P')
    DROP PROCEDURE exp2
 GO


### 幻灯片 23

4.2 存储过程
4.2.2创建和管理SQLServer存储过程
3．带默认参数的存储过程
【例4.8】创建一个带默认参数的存储过程，通过传递的参数显示物资的名称、规格、项目名称、是否按期完工等信息，如果没有提供参数，则使用预设的默认值。
CREATE PROCEDURE exp4 
@mname varchar(50)='%绝缘%', @pno char(8)='20110001'
   AS
        SELECT mat_name,speci,prj_name,prj_status  
        FROM  stock, salvaging, out_stock 
        WHERE stock.mat_num=out_stock.mat_num 
          and salvaging.prj_num=out_stock.prj_num
          and mat_name like @mname 
          and salvaging.prj_num=@pno
执行创建的存储过程exp4。
   EXECUTE  exp4 
或：
   EXECUTE  exp4 '%绝缘电线'
或：
   EXECUTE  exp4 @pno='20110002'
或：
   EXECUTE  exp4 ‘护套绝缘电线 ','20110002'


### 幻灯片 24

4.2 存储过程
4.2.2创建和管理SQLServer存储过程
4．带输出参数的存储过程
【例4.9】创建一个存储过程，根据输入的抢修工程项目号统计其领取物资的总数量，并要求输出。
CREATE PROCEDURE exp4

AS
  SELECT               sum(amount)
  FROM Out_stock
  WHERE prj_num=
@sum=
@pn
@pn char(8),  @sum int OUTPUT
OUTPUT指明输出参数，可以返回到调用存储过程的批处理或其他存储过程中。
执行：
   DECLARE @total int 
   EXECUTE exp4 '20110001', @total OUTPUT
   PRINT '该项目领取物资总量为：'+ CAST(@total AS varchar(20))


### 幻灯片 25

4.2 存储过程
4.2.2创建和管理SQLServer存储过程
【例4.10】 创建一个存储过程，根据输入的工程部门及起止时间段，汇总该部门在对应时间段内所参与抢修的工程项目总数以及领取物资的总成本，并要求输出。
select 

FROM salvaging,out_stock,stock 
WHERE out_stock.prj_num =salvaging.prj_num 
	and out_stock.mat_num =Stock.mat_num
	and department =
	and get_date between                      and
COUNT(DISTINCT out_stock.prj_num),
@department
CREATE PROCEDURE exp5
       @department varchar(50),@start_date datetime,@end_date datetime,
      @count_prj int OUTPUT, @sum_cost decimal(18,2) OUTPUT  
AS
@sum_cost=
@count_prj=
SUM(Out_stock.amount*Stock.unit)
@start_date
@end_date


### 幻灯片 26

4.2 存储过程
4.2.2创建和管理SQLServer存储过程
执行存储过程exp5的语句如下：

DECLARE @prjcounts int, @sumcosts decimal(18,2)
EXEC exp5 '工程2部','2011-1-1','2011-1-31’, @prjcounts OUTPUT,   @sumcosts OUTPUT
PRINT '该部门参与抢修工程项目'+ CAST(@prjcounts AS varchar(20))+'个，总成本为'+CAST(@sumcosts AS varchar(20))


### 幻灯片 27

4.2 存储过程
4.2.2创建和管理SQLServer存储过程
5．嵌套调用存储过程
【例4.11】 嵌套调用存储过程，查看使用抢修物资总数最多的工程项目信息。
CREATE PROCEDURE exp6
@prj_no char(8) OUTPUT
AS
  SELECT TOP 1   @prj_no=prj_num
  FROM out_stock
  GROUP BY prj_num
  ORDER BY SUM(amount)   DESC
GO
CREATE PROCEDURE exp7
AS
  DECLARE @prj_id char(8)
  EXEC exp6 @prj_id OUTPUT
  SELECT *
  FROM Salvaging
  WHERE prj_num=@prj_id
GO
执行存储过程：EXECUTE  exp7


### 幻灯片 28

4.2 存储过程
4.2.3创建和管理SQLServer存储过程
修改存储过程的语句是：
ALTER PROCEDURE 存储过程名 [；版本号]
[{@参数 数据类型} [ VARYING ] [=默认值][ OUTPUT ],
……]
[WITH{ RECOMPILE|ENCRYPTION|RECOMPILE,ENCRYPTION}] 
[ FOR REPLICATION ] 
AS 
   SQL语句

删除存储过程的语句是：
   DROP PROCEDURE   存储过程名


### 幻灯片 29

小结
存储过程的基本概念
创建存储过程
修改和删除存储过程
谢谢观看！

---

